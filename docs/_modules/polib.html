

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>polib &mdash; Python CLI Applications Documentations  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/python-logo.svg"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Python CLI Applications Documentations
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../includes/1-general-notes.html">General development notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/CLIApplicationsManager/index.html">CLI applications manager’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/BackupUtils/index.html">Backup Utils’ documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/ChrootHelper/index.html">Chroot Helpers’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/FilesCleaner/index.html">Files Cleaner’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/HostsManager/index.html">Hosts Manager’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/KnowledgeBase/index.html">Knowledge Base’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/MakeCinnamonXletPOT/index.html">Make Cinnamon Xlet POT’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/MoviesDB/index.html">Movies DB’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/PackageManager/index.html">Package Manager’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/UserApplicationsManager/index.html">User Applications Manager’s documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../includes/0-thirdparty_docs.d/docopt.html">docopt’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/0-thirdparty_docs.d/polib/index.html">polib’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/0-thirdparty_docs.d/pyperclip/index.html">pyperclip’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/0-thirdparty_docs.d/titlecase.html">titlecase’s documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../includes/0-thirdparty_docs.d/tqdm.html">tqdm’s documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Python CLI Applications Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>polib</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for polib</h1><div class="highlight"><pre>
<span></span><span class="c1"># -* coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># License: MIT (see LICENSE file provided)</span>
<span class="c1"># vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4:</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">**polib** allows you to manipulate, create, modify gettext files (pot, po and</span>
<span class="sd">mo files).  You can load existing files, iterate through it&#39;s entries, add,</span>
<span class="sd">modify entries, comments or metadata, etc. or create new po files from scratch.</span>

<span class="sd">**polib** provides a simple and pythonic API via the :func:`~polib.pofile` and</span>
<span class="sd">:func:`~polib.mofile` convenience functions.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># replacement of io.open() for python &lt; 2.6</span>
    <span class="c1"># we use codecs instead</span>
    <span class="k">class</span> <span class="nc">io</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;David Jean Louis &lt;izimobil@gmail.com&gt;&#39;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.1.0&#39;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pofile&#39;</span><span class="p">,</span> <span class="s1">&#39;POFile&#39;</span><span class="p">,</span> <span class="s1">&#39;POEntry&#39;</span><span class="p">,</span> <span class="s1">&#39;mofile&#39;</span><span class="p">,</span> <span class="s1">&#39;MOFile&#39;</span><span class="p">,</span> <span class="s1">&#39;MOEntry&#39;</span><span class="p">,</span>
           <span class="s1">&#39;default_encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;escape&#39;</span><span class="p">,</span> <span class="s1">&#39;unescape&#39;</span><span class="p">,</span> <span class="s1">&#39;detect_encoding&#39;</span><span class="p">,</span> <span class="p">]</span>


<span class="c1"># the default encoding to use when encoding cannot be detected</span>
<span class="n">default_encoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>

<span class="c1"># python 2/3 compatibility helpers {{{</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">PY3</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">text_type</span> <span class="o">=</span> <span class="n">unicode</span>

    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;unicode_escape&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">PY3</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">text_type</span> <span class="o">=</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
<span class="c1"># }}}</span>
<span class="c1"># _pofile_or_mofile {{{</span>


<span class="k">def</span> <span class="nf">_pofile_or_mofile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function used by :func:`polib.pofile` and :func:`polib.mofile` to</span>
<span class="sd">    honor the DRY concept.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the file encoding</span>
    <span class="n">enc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">detect_encoding</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;mofile&#39;</span><span class="p">)</span>

    <span class="c1"># parse the file</span>
    <span class="n">kls</span> <span class="o">=</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;pofile&#39;</span> <span class="ow">and</span> <span class="n">_POFileParser</span> <span class="ow">or</span> <span class="n">_MOFileParser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">kls</span><span class="p">(</span>
        <span class="n">f</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span>
        <span class="n">check_for_duplicates</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_for_duplicates&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">klass</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">wrapwidth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wrapwidth&#39;</span><span class="p">,</span> <span class="mi">78</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span>
<span class="c1"># }}}</span>
<span class="c1"># _is_file {{{</span>


<span class="k">def</span> <span class="nf">_is_file</span><span class="p">(</span><span class="n">filename_or_contents</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safely returns the value of os.path.exists(filename_or_contents).</span>

<span class="sd">    Arguments:</span>

<span class="sd">    ``filename_or_contents``</span>
<span class="sd">        either a filename, or a string holding the contents of some file.</span>
<span class="sd">        In the latter case, this function will always return False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename_or_contents</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">UnicodeEncodeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
<span class="c1"># }}}</span>
<span class="c1"># function pofile() {{{</span>


<div class="viewcode-block" id="pofile"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.pofile">[docs]</a><span class="k">def</span> <span class="nf">pofile</span><span class="p">(</span><span class="n">pofile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function that parses the po or pot file ``pofile`` and returns</span>
<span class="sd">    a :class:`~polib.POFile` instance.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    ``pofile``</span>
<span class="sd">        string, full or relative path to the po/pot file or its content (data).</span>

<span class="sd">    ``wrapwidth``</span>
<span class="sd">        integer, the wrap width, only useful when the ``-w`` option was passed</span>
<span class="sd">        to xgettext (optional, default: ``78``).</span>

<span class="sd">    ``encoding``</span>
<span class="sd">        string, the encoding to use (e.g. &quot;utf-8&quot;) (default: ``None``, the</span>
<span class="sd">        encoding will be auto-detected).</span>

<span class="sd">    ``check_for_duplicates``</span>
<span class="sd">        whether to check for duplicate entries when adding entries to the</span>
<span class="sd">        file (optional, default: ``False``).</span>

<span class="sd">    ``klass``</span>
<span class="sd">        class which is used to instantiate the return value (optional,</span>
<span class="sd">        default: ``None``, the return value with be a :class:`~polib.POFile`</span>
<span class="sd">        instance).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_pofile_or_mofile</span><span class="p">(</span><span class="n">pofile</span><span class="p">,</span> <span class="s1">&#39;pofile&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<span class="c1"># }}}</span>
<span class="c1"># function mofile() {{{</span>


<div class="viewcode-block" id="mofile"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.mofile">[docs]</a><span class="k">def</span> <span class="nf">mofile</span><span class="p">(</span><span class="n">mofile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function that parses the mo file ``mofile`` and returns a</span>
<span class="sd">    :class:`~polib.MOFile` instance.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    ``mofile``</span>
<span class="sd">        string, full or relative path to the mo file or its content (data).</span>

<span class="sd">    ``wrapwidth``</span>
<span class="sd">        integer, the wrap width, only useful when the ``-w`` option was passed</span>
<span class="sd">        to xgettext to generate the po file that was used to format the mo file</span>
<span class="sd">        (optional, default: ``78``).</span>

<span class="sd">    ``encoding``</span>
<span class="sd">        string, the encoding to use (e.g. &quot;utf-8&quot;) (default: ``None``, the</span>
<span class="sd">        encoding will be auto-detected).</span>

<span class="sd">    ``check_for_duplicates``</span>
<span class="sd">        whether to check for duplicate entries when adding entries to the</span>
<span class="sd">        file (optional, default: ``False``).</span>

<span class="sd">    ``klass``</span>
<span class="sd">        class which is used to instantiate the return value (optional,</span>
<span class="sd">        default: ``None``, the return value with be a :class:`~polib.POFile`</span>
<span class="sd">        instance).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_pofile_or_mofile</span><span class="p">(</span><span class="n">mofile</span><span class="p">,</span> <span class="s1">&#39;mofile&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<span class="c1"># }}}</span>
<span class="c1"># function detect_encoding() {{{</span>


<div class="viewcode-block" id="detect_encoding"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.detect_encoding">[docs]</a><span class="k">def</span> <span class="nf">detect_encoding</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">binary_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to detect the encoding used by the ``file``. The ``file`` argument can</span>
<span class="sd">    be a PO or MO file path or a string containing the contents of the file.</span>
<span class="sd">    If the encoding cannot be detected, the function will return the value of</span>
<span class="sd">    ``default_encoding``.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    ``file``</span>
<span class="sd">        string, full or relative path to the po/mo file or its content.</span>

<span class="sd">    ``binary_mode``</span>
<span class="sd">        boolean, set this to True if ``file`` is a mo file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PATTERN</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&quot;?Content-Type:.+? charset=([\w_\-:\.]+)&#39;</span>
    <span class="n">rxt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="n">PATTERN</span><span class="p">))</span>
    <span class="n">rxb</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">PATTERN</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">charset_exists</span><span class="p">(</span><span class="n">charset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check whether ``charset`` is valid or not.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">charset</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_file</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">rxt</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">enc</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">charset_exists</span><span class="p">(</span><span class="n">enc</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">enc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For PY3, always treat as binary</span>
        <span class="k">if</span> <span class="n">binary_mode</span> <span class="ow">or</span> <span class="n">PY3</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;rb&#39;</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">rxb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="n">rx</span> <span class="o">=</span> <span class="n">rxt</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">enc</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                    <span class="n">enc</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">charset_exists</span><span class="p">(</span><span class="n">enc</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">enc</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">default_encoding</span></div>
<span class="c1"># }}}</span>
<span class="c1"># function escape() {{{</span>


<div class="viewcode-block" id="escape"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.escape">[docs]</a><span class="k">def</span> <span class="nf">escape</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escapes the characters ``\\\\``, ``\\t``, ``\\n``, ``\\r`` and ``&quot;`` in</span>
<span class="sd">    the given string ``st`` and returns it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">st</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\t&#39;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\r&#39;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\&quot;&#39;</span><span class="p">)</span></div>
<span class="c1"># }}}</span>
<span class="c1"># function unescape() {{{</span>


<div class="viewcode-block" id="unescape"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.unescape">[docs]</a><span class="k">def</span> <span class="nf">unescape</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unescapes the characters ``\\\\``, ``\\t``, ``\\n``, ``\\r`` and ``&quot;`` in</span>
<span class="sd">    the given string ``st`` and returns it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">unescape_repl</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">m</span>  <span class="c1"># handles escaped double quote</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">(</span><span class="se">\\</span><span class="s1">|n|t|r|&quot;)&#39;</span><span class="p">,</span> <span class="n">unescape_repl</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span></div>
<span class="c1"># }}}</span>
<span class="c1"># function natural_sort() {{{</span>


<span class="k">def</span> <span class="nf">natural_sort</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort naturally the given list.</span>
<span class="sd">    Credits: http://stackoverflow.com/a/4836734</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">else</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">alphanum_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">convert</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;([0-9]+)&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">alphanum_key</span><span class="p">)</span>

<span class="c1"># }}}</span>
<span class="c1"># class _BaseFile {{{</span>


<span class="k">class</span> <span class="nc">_BaseFile</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common base class for the :class:`~polib.POFile` and :class:`~polib.MOFile`</span>
<span class="sd">    classes. This class should **not** be instantiated directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor, accepts the following keyword arguments:</span>

<span class="sd">        ``pofile``</span>
<span class="sd">            string, the path to the po or mo file, or its content as a string.</span>

<span class="sd">        ``wrapwidth``</span>
<span class="sd">            integer, the wrap width, only useful when the ``-w`` option was</span>
<span class="sd">            passed to xgettext (optional, default: ``78``).</span>

<span class="sd">        ``encoding``</span>
<span class="sd">            string, the encoding to use, defaults to ``default_encoding``</span>
<span class="sd">            global variable (optional).</span>

<span class="sd">        ``check_for_duplicates``</span>
<span class="sd">            whether to check for duplicate entries when adding entries to the</span>
<span class="sd">            file, (optional, default: ``False``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">list</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># the opened file handle</span>
        <span class="n">pofile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pofile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pofile</span> <span class="ow">and</span> <span class="n">_is_file</span><span class="p">(</span><span class="n">pofile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">pofile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fpath&#39;</span><span class="p">)</span>
        <span class="c1"># the width at which lines should be wrapped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wrapwidth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wrapwidth&#39;</span><span class="p">,</span> <span class="mi">78</span><span class="p">)</span>
        <span class="c1"># the file encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">)</span>
        <span class="c1"># whether to check for duplicate entries or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_for_duplicates</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_for_duplicates&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># both po and mo files have metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_is_fuzzy</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the unicode representation of the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_as_entry</span><span class="p">()]</span> <span class="o">+</span> \
                  <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">obsolete</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapwidth</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete_entries</span><span class="p">():</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapwidth</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the string representation of the file.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden ``list`` method to implement the membership test (in and</span>
<span class="sd">        not in).</span>
<span class="sd">        The method considers that an entry is in the file if it finds an entry</span>
<span class="sd">        that has the same msgid (the test is **case sensitive**) and the same</span>
<span class="sd">        msgctxt (or none for both entries).</span>

<span class="sd">        Argument:</span>

<span class="sd">        ``entry``</span>
<span class="sd">            an instance of :class:`~polib._BaseEntry`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">msgid</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;msgid&#39;</span><span class="p">,</span> <span class="n">msgctxt</span><span class="o">=</span><span class="n">entry</span><span class="o">.</span><span class="n">msgctxt</span><span class="p">)</span> \
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden method to check for duplicates entries, if a user tries to</span>
<span class="sd">        add an entry that is already in the file, the method will raise a</span>
<span class="sd">        ``ValueError`` exception.</span>

<span class="sd">        Argument:</span>

<span class="sd">        ``entry``</span>
<span class="sd">            an instance of :class:`~polib._BaseEntry`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check_for_duplicates may not be defined (yet) when unpickling.</span>
        <span class="c1"># But if pickling, we never want to check for duplicates anyway.</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;check_for_duplicates&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Entry &quot;</span><span class="si">%s</span><span class="s1">&quot; already exists&#39;</span> <span class="o">%</span> <span class="n">entry</span><span class="o">.</span><span class="n">msgid</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_BaseFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden method to check for duplicates entries, if a user tries to</span>
<span class="sd">        add an entry that is already in the file, the method will raise a</span>
<span class="sd">        ``ValueError`` exception.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        ``index``</span>
<span class="sd">            index at which the entry should be inserted.</span>

<span class="sd">        ``entry``</span>
<span class="sd">            an instance of :class:`~polib._BaseEntry`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_duplicates</span> <span class="ow">and</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Entry &quot;</span><span class="si">%s</span><span class="s1">&quot; already exists&#39;</span> <span class="o">%</span> <span class="n">entry</span><span class="o">.</span><span class="n">msgid</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_BaseFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">metadata_as_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the file metadata as a :class:`~polib.POFile` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">msgid</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">mdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordered_metadata</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mdata</span><span class="p">:</span>
            <span class="n">strs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mdata</span><span class="p">:</span>
                <span class="c1"># Strip whitespace off each line in a multi-line entry</span>
                <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">e</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_is_fuzzy</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fuzzy&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repr_method</span><span class="o">=</span><span class="s1">&#39;__unicode__&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the po file to ``fpath``.</span>
<span class="sd">        If it is an existing file and no ``fpath`` is provided, then the</span>
<span class="sd">        existing file is rewritten with the modified data.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        ``fpath``</span>
<span class="sd">            string, full or relative path to the file.</span>

<span class="sd">        ``repr_method``</span>
<span class="sd">            string, the method to use for output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;You must provide a file path to save() method&#39;</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repr_method</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span>
        <span class="k">if</span> <span class="n">repr_method</span> <span class="o">==</span> <span class="s1">&#39;to_binary&#39;</span><span class="p">:</span>
            <span class="n">fhandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fhandle</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">fhandle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># set the file path if not set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s1">&#39;msgid&#39;</span><span class="p">,</span> <span class="n">include_obsolete_entries</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">msgctxt</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the entry which msgid (or property identified by the ``by``</span>
<span class="sd">        argument) matches the string ``st``.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        ``st``</span>
<span class="sd">            string, the string to search for.</span>

<span class="sd">        ``by``</span>
<span class="sd">            string, the property to use for comparison (default: ``msgid``).</span>

<span class="sd">        ``include_obsolete_entries``</span>
<span class="sd">            boolean, whether to also search in entries that are obsolete.</span>

<span class="sd">        ``msgctxt``</span>
<span class="sd">            string, allows specifying a specific message context for the</span>
<span class="sd">            search.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">include_obsolete_entries</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">obsolete</span><span class="p">]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span> <span class="o">==</span> <span class="n">st</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">msgctxt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">msgctxt</span> <span class="o">!=</span> <span class="n">msgctxt</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msgctxt</span><span class="p">:</span>
                <span class="c1"># find the entry with no msgctx</span>
                <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">msgctxt</span><span class="p">:</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">m</span>
                <span class="k">if</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">e</span>
                <span class="c1"># fallback to the first entry found</span>
                <span class="k">return</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">ordered_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that returns an ordered version of the metadata</span>
<span class="sd">        dictionary. The return value is list of tuples (metadata name,</span>
<span class="sd">        metadata_value).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># copy the dict first</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data_order</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;Project-Id-Version&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Report-Msgid-Bugs-To&#39;</span><span class="p">,</span>
            <span class="s1">&#39;POT-Creation-Date&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PO-Revision-Date&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Last-Translator&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Language-Team&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Language&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MIME-Version&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Transfer-Encoding&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Plural-Forms&#39;</span>
        <span class="p">]</span>
        <span class="n">ordered_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_order</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">ordered_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># the rest of the metadata will be alphabetically ordered since there</span>
        <span class="c1"># are no specs for this AFAIK</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">natural_sort</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">data</span><span class="p">]</span>
            <span class="n">ordered_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ordered_data</span>

    <span class="k">def</span> <span class="nf">to_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the binary representation of the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translated_entries</span><span class="p">()</span>

        <span class="c1"># the keys are sorted in the .mo file</span>
        <span class="k">def</span> <span class="nf">cmp</span><span class="p">(</span><span class="n">_self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
            <span class="c1"># msgfmt compares entries with msgctxt if it exists</span>
            <span class="n">self_msgid</span> <span class="o">=</span> <span class="n">_self</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">and</span> <span class="n">_self</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">or</span> <span class="n">_self</span><span class="o">.</span><span class="n">msgid</span>
            <span class="n">other_msgid</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">msgid</span>
            <span class="k">if</span> <span class="n">self_msgid</span> <span class="o">&gt;</span> <span class="n">other_msgid</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">self_msgid</span> <span class="o">&lt;</span> <span class="n">other_msgid</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># add metadata entry</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">msgid_with_context</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">mentry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_as_entry</span><span class="p">()</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">mentry</span><span class="p">]</span> <span class="o">+</span> <span class="n">entries</span>
        <span class="n">entries_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">strs</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">b</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="c1"># For each string, we need size and file offset.  Each string is</span>
            <span class="c1"># NUL terminated; the NUL does not count into the size.</span>
            <span class="n">msgid</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">msgctxt</span><span class="p">:</span>
                <span class="c1"># Contexts are stored by storing the concatenation of the</span>
                <span class="c1"># context, a &lt;EOT&gt; byte, and the original string</span>
                <span class="n">msgid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgctxt</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\4</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">msgid_plural</span><span class="p">:</span>
                <span class="n">msgstr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">msgstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="n">msgid</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgid</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">msgid_plural</span><span class="p">)</span>
                <span class="n">msgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgstr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msgid</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgid</span><span class="p">)</span>
                <span class="n">msgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">msgstr</span><span class="p">)</span>
            <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgid</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">strs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgstr</span><span class="p">)))</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="n">msgid</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">strs</span> <span class="o">+=</span> <span class="n">msgstr</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># The header is 7 32-bit unsigned integers.</span>
        <span class="n">keystart</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">entries_len</span>
        <span class="c1"># and the values start after the keys</span>
        <span class="n">valuestart</span> <span class="o">=</span> <span class="n">keystart</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">koffsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">voffsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># The string table first has the list of keys, then the list of values.</span>
        <span class="c1"># Each entry has first the size of the string, then the file offset.</span>
        <span class="k">for</span> <span class="n">o1</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">:</span>
            <span class="n">koffsets</span> <span class="o">+=</span> <span class="p">[</span><span class="n">l1</span><span class="p">,</span> <span class="n">o1</span> <span class="o">+</span> <span class="n">keystart</span><span class="p">]</span>
            <span class="n">voffsets</span> <span class="o">+=</span> <span class="p">[</span><span class="n">l2</span><span class="p">,</span> <span class="n">o2</span> <span class="o">+</span> <span class="n">valuestart</span><span class="p">]</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="n">koffsets</span> <span class="o">+</span> <span class="n">voffsets</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
            <span class="s2">&quot;Iiiiiii&quot;</span><span class="p">,</span>
            <span class="c1"># Magic number</span>
            <span class="n">MOFile</span><span class="o">.</span><span class="n">MAGIC</span><span class="p">,</span>
            <span class="c1"># Version</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># number of entries</span>
            <span class="n">entries_len</span><span class="p">,</span>
            <span class="c1"># start of key index</span>
            <span class="mi">7</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
            <span class="c1"># start of value index</span>
            <span class="mi">7</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">entries_len</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
            <span class="c1"># size and offset of hash table, we don&#39;t use hash tables</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">keystart</span>

        <span class="p">)</span>
        <span class="k">if</span> <span class="n">PY3</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># python 3.2 or superior</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">ids</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">strs</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mixed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Encodes the given ``mixed`` argument with the file encoding if and</span>
<span class="sd">        only if it&#39;s an unicode string and returns the encoded string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mixed</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">mixed</span> <span class="o">=</span> <span class="n">mixed</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mixed</span>
<span class="c1"># }}}</span>
<span class="c1"># class POFile {{{</span>


<div class="viewcode-block" id="POFile"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile">[docs]</a><span class="k">class</span> <span class="nc">POFile</span><span class="p">(</span><span class="n">_BaseFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Po (or Pot) file reader/writer.</span>
<span class="sd">    This class inherits the :class:`~polib._BaseFile` class and, by extension,</span>
<span class="sd">    the python ``list`` type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="POFile.__unicode__"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.__unicode__">[docs]</a>    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the unicode representation of the po file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="s2">&quot;#</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="n">header</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">]:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;#</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">header</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="s1">&#39;# </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">header</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">_BaseFile</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="POFile.save_as_mofile"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.save_as_mofile">[docs]</a>    <span class="k">def</span> <span class="nf">save_as_mofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the binary representation of the file to given ``fpath``.</span>

<span class="sd">        Keyword argument:</span>

<span class="sd">        ``fpath``</span>
<span class="sd">            string, full or relative path to the mo file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_BaseFile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;to_binary&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="POFile.percent_translated"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.percent_translated">[docs]</a>    <span class="k">def</span> <span class="nf">percent_translated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that returns the percentage of translated</span>
<span class="sd">        messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">obsolete</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">100</span>
        <span class="n">translated</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">translated_entries</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">translated</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total</span><span class="p">))</span></div>

<div class="viewcode-block" id="POFile.translated_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.translated_entries">[docs]</a>    <span class="k">def</span> <span class="nf">translated_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that returns the list of translated entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">translated</span><span class="p">()]</span></div>

<div class="viewcode-block" id="POFile.untranslated_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.untranslated_entries">[docs]</a>    <span class="k">def</span> <span class="nf">untranslated_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that returns the list of untranslated entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">translated</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">obsolete</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">fuzzy</span><span class="p">]</span></div>

<div class="viewcode-block" id="POFile.fuzzy_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.fuzzy_entries">[docs]</a>    <span class="k">def</span> <span class="nf">fuzzy_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that returns the list of fuzzy entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">fuzzy</span><span class="p">]</span></div>

<div class="viewcode-block" id="POFile.obsolete_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.obsolete_entries">[docs]</a>    <span class="k">def</span> <span class="nf">obsolete_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that returns the list of obsolete entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">obsolete</span><span class="p">]</span></div>

<div class="viewcode-block" id="POFile.merge"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POFile.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refpot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method that merges the current pofile with the pot file</span>
<span class="sd">        provided. It behaves exactly as the gettext msgmerge utility:</span>

<span class="sd">        * comments of this file will be preserved, but extracted comments and</span>
<span class="sd">          occurrences will be discarded;</span>
<span class="sd">        * any translations or comments in the file will be discarded, however,</span>
<span class="sd">          dot comments and file positions will be preserved;</span>
<span class="sd">        * the fuzzy flags are preserved.</span>

<span class="sd">        Keyword argument:</span>

<span class="sd">        ``refpot``</span>
<span class="sd">            object POFile, the reference catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store entries in dict/set for faster access</span>
        <span class="n">self_entries</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">msgid_with_context</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="p">)</span>
        <span class="n">refpot_msgids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">msgid_with_context</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">refpot</span><span class="p">)</span>
        <span class="c1"># Merge entries that are in the refpot</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">refpot</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">self_entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">msgid_with_context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="c1"># ok, now we must &quot;obsolete&quot; entries that are not in the refpot anymore</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">msgid_with_context</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">refpot_msgids</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">obsolete</span> <span class="o">=</span> <span class="kc">True</span></div></div>
<span class="c1"># }}}</span>
<span class="c1"># class MOFile {{{</span>


<div class="viewcode-block" id="MOFile"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile">[docs]</a><span class="k">class</span> <span class="nc">MOFile</span><span class="p">(</span><span class="n">_BaseFile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mo file reader/writer.</span>
<span class="sd">    This class inherits the :class:`~polib._BaseFile` class and, by</span>
<span class="sd">    extension, the python ``list`` type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MAGIC</span> <span class="o">=</span> <span class="mh">0x950412de</span>
    <span class="n">MAGIC_SWAPPED</span> <span class="o">=</span> <span class="mh">0xde120495</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor, accepts all keywords arguments accepted by</span>
<span class="sd">        :class:`~polib._BaseFile` class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_BaseFile</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magic_number</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="MOFile.save_as_pofile"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.save_as_pofile">[docs]</a>    <span class="k">def</span> <span class="nf">save_as_pofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the mofile as a pofile to ``fpath``.</span>

<span class="sd">        Keyword argument:</span>

<span class="sd">        ``fpath``</span>
<span class="sd">            string, full or relative path to the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_BaseFile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span></div>

<div class="viewcode-block" id="MOFile.save"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the mofile to ``fpath``.</span>

<span class="sd">        Keyword argument:</span>

<span class="sd">        ``fpath``</span>
<span class="sd">            string, full or relative path to the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_BaseFile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;to_binary&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MOFile.percent_translated"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.percent_translated">[docs]</a>    <span class="k">def</span> <span class="nf">percent_translated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to keep the same interface with POFile instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">100</span></div>

<div class="viewcode-block" id="MOFile.translated_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.translated_entries">[docs]</a>    <span class="k">def</span> <span class="nf">translated_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to keep the same interface with POFile instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MOFile.untranslated_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.untranslated_entries">[docs]</a>    <span class="k">def</span> <span class="nf">untranslated_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to keep the same interface with POFile instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="MOFile.fuzzy_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.fuzzy_entries">[docs]</a>    <span class="k">def</span> <span class="nf">fuzzy_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to keep the same interface with POFile instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="MOFile.obsolete_entries"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOFile.obsolete_entries">[docs]</a>    <span class="k">def</span> <span class="nf">obsolete_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to keep the same interface with POFile instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div></div>
<span class="c1"># }}}</span>
<span class="c1"># class _BaseEntry {{{</span>


<span class="k">class</span> <span class="nc">_BaseEntry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for :class:`~polib.POEntry` and :class:`~polib.MOEntry` classes.</span>
<span class="sd">    This class should **not** be instantiated directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor, accepts the following keyword arguments:</span>

<span class="sd">        ``msgid``</span>
<span class="sd">            string, the entry msgid.</span>

<span class="sd">        ``msgstr``</span>
<span class="sd">            string, the entry msgstr.</span>

<span class="sd">        ``msgid_plural``</span>
<span class="sd">            string, the entry msgid_plural.</span>

<span class="sd">        ``msgstr_plural``</span>
<span class="sd">            list, the entry msgstr_plural lines.</span>

<span class="sd">        ``msgctxt``</span>
<span class="sd">            string, the entry context (msgctxt).</span>

<span class="sd">        ``obsolete``</span>
<span class="sd">            bool, whether the entry is &quot;obsolete&quot; or not.</span>

<span class="sd">        ``encoding``</span>
<span class="sd">            string, the encoding to use, defaults to ``default_encoding``</span>
<span class="sd">            global variable (optional).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msgid&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msgstr&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgid_plural</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msgid_plural&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msgstr_plural&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msgctxt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;obsolete&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapwidth</span><span class="o">=</span><span class="mi">78</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the unicode representation of the entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="n">delflag</span> <span class="o">=</span> <span class="s1">&#39;#~ &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delflag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># write the msgctxt if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_field</span><span class="p">(</span><span class="s2">&quot;msgctxt&quot;</span><span class="p">,</span> <span class="n">delflag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span><span class="p">,</span>
                                   <span class="n">wrapwidth</span><span class="p">)</span>
        <span class="c1"># write the msgid</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_field</span><span class="p">(</span><span class="s2">&quot;msgid&quot;</span><span class="p">,</span> <span class="n">delflag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span><span class="p">,</span> <span class="n">wrapwidth</span><span class="p">)</span>
        <span class="c1"># write the msgid_plural if any</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid_plural</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_field</span><span class="p">(</span><span class="s2">&quot;msgid_plural&quot;</span><span class="p">,</span> <span class="n">delflag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">msgid_plural</span><span class="p">,</span> <span class="n">wrapwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">:</span>
            <span class="c1"># write the msgstr_plural if any</span>
            <span class="n">msgstrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">msgstrs</span><span class="p">)</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">msgstr</span> <span class="o">=</span> <span class="n">msgstrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="n">plural_index</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">index</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_field</span><span class="p">(</span><span class="s2">&quot;msgstr&quot;</span><span class="p">,</span> <span class="n">delflag</span><span class="p">,</span> <span class="n">plural_index</span><span class="p">,</span> <span class="n">msgstr</span><span class="p">,</span>
                                       <span class="n">wrapwidth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise write the msgstr</span>
            <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_field</span><span class="p">(</span><span class="s2">&quot;msgstr&quot;</span><span class="p">,</span> <span class="n">delflag</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span><span class="p">,</span>
                                   <span class="n">wrapwidth</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the string representation of the entry.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_str_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">delflag</span><span class="p">,</span> <span class="n">plural_index</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span>
                   <span class="n">wrapwidth</span><span class="o">=</span><span class="mi">78</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span>  <span class="c1"># start with initial empty line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">escaped_field</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">specialchars_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">]:</span>
                <span class="n">specialchars_count</span> <span class="o">+=</span> <span class="n">field</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c1"># comparison must take into account fieldname length + one space</span>
            <span class="c1"># + 2 quotes (eg. msgid &quot;&lt;string&gt;&quot;)</span>
            <span class="n">flength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">plural_index</span><span class="p">:</span>
                <span class="n">flength</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plural_index</span><span class="p">)</span>
            <span class="n">real_wrapwidth</span> <span class="o">=</span> <span class="n">wrapwidth</span> <span class="o">-</span> <span class="n">flength</span> <span class="o">+</span> <span class="n">specialchars_count</span>
            <span class="k">if</span> <span class="n">wrapwidth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">real_wrapwidth</span><span class="p">:</span>
                <span class="c1"># Wrap the line but take field name into account</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">unescape</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">wrap</span><span class="p">(</span>
                    <span class="n">escaped_field</span><span class="p">,</span>
                    <span class="n">wrapwidth</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 2 for quotes &quot;&quot;</span>
                    <span class="n">drop_whitespace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">break_long_words</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fieldname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;previous_&#39;</span><span class="p">):</span>
            <span class="c1"># quick and dirty trick to get the real field name</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldname</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delflag</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">plural_index</span><span class="p">,</span>
                                <span class="n">escape</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delflag</span><span class="p">,</span> <span class="n">escape</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ret</span>
<span class="c1"># }}}</span>
<span class="c1"># class POEntry {{{</span>


<div class="viewcode-block" id="POEntry"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POEntry">[docs]</a><span class="k">class</span> <span class="nc">POEntry</span><span class="p">(</span><span class="n">_BaseEntry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a po file entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor, accepts the following keyword arguments:</span>

<span class="sd">        ``comment``</span>
<span class="sd">            string, the entry comment.</span>

<span class="sd">        ``tcomment``</span>
<span class="sd">            string, the entry translator comment.</span>

<span class="sd">        ``occurrences``</span>
<span class="sd">            list, the entry occurrences.</span>

<span class="sd">        ``flags``</span>
<span class="sd">            list, the entry flags.</span>

<span class="sd">        ``previous_msgctxt``</span>
<span class="sd">            string, the entry previous context.</span>

<span class="sd">        ``previous_msgid``</span>
<span class="sd">            string, the entry previous msgid.</span>

<span class="sd">        ``previous_msgid_plural``</span>
<span class="sd">            string, the entry previous msgid_plural.</span>

<span class="sd">        ``linenum``</span>
<span class="sd">            integer, the line number of the entry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_BaseEntry</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcomment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tcomment&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;occurrences&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flags&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgctxt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_msgctxt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_msgid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgid_plural</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_msgid_plural&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linenum</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linenum&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="POEntry.__unicode__"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POEntry.__unicode__">[docs]</a>    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapwidth</span><span class="o">=</span><span class="mi">78</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the unicode representation of the entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># comments first, if any (with text wrapping as xgettext does)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;tcomment&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;#. &#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tcomment&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">wrapwidth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">wrapwidth</span><span class="p">:</span>
                        <span class="n">ret</span> <span class="o">+=</span> <span class="n">wrap</span><span class="p">(</span>
                            <span class="n">comment</span><span class="p">,</span>
                            <span class="n">wrapwidth</span><span class="p">,</span>
                            <span class="n">initial_indent</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">subsequent_indent</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">break_long_words</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">comment</span><span class="p">))</span>

        <span class="c1"># occurrences (with text wrapping as xgettext does)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span><span class="p">:</span>
            <span class="n">filelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fpath</span><span class="p">,</span> <span class="n">lineno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lineno</span><span class="p">:</span>
                    <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
            <span class="n">filestr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filelist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wrapwidth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">filestr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">wrapwidth</span><span class="p">:</span>
                <span class="c1"># textwrap split words that contain hyphen, this is not</span>
                <span class="c1"># what we want for filenames, so the dirty hack is to</span>
                <span class="c1"># temporally replace hyphens with a char that a file cannot</span>
                <span class="c1"># contain, like &quot;*&quot;</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">wrap</span><span class="p">(</span>
                    <span class="n">filestr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">),</span>
                    <span class="n">wrapwidth</span><span class="p">,</span>
                    <span class="n">initial_indent</span><span class="o">=</span><span class="s1">&#39;#: &#39;</span><span class="p">,</span>
                    <span class="n">subsequent_indent</span><span class="o">=</span><span class="s1">&#39;#: &#39;</span><span class="p">,</span>
                    <span class="n">break_long_words</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#: &#39;</span> <span class="o">+</span> <span class="n">filestr</span><span class="p">)</span>

        <span class="c1"># flags (TODO: wrapping ?)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">))</span>

        <span class="c1"># previous context and previous msgid/msgid_plural</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;previous_msgctxt&#39;</span><span class="p">,</span> <span class="s1">&#39;previous_msgid&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;previous_msgid_plural&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;#~| &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;#| &quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str_field</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">wrapwidth</span><span class="p">)</span>

        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_BaseEntry</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapwidth</span><span class="p">))</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="POEntry.__cmp__"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POEntry.__cmp__">[docs]</a>    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by comparison operations if rich comparison is not defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First: Obsolete test</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
        <span class="c1"># Work on a copy to protect original</span>
        <span class="n">occ1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span><span class="p">[:])</span>
        <span class="n">occ2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">occurrences</span><span class="p">[:])</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">occ1</span> <span class="o">&gt;</span> <span class="n">occ2</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">occ1</span> <span class="o">&lt;</span> <span class="n">occ2</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Compare context</span>
        <span class="n">msgctxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">othermsgctxt</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgctxt</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">msgctxt</span> <span class="o">&gt;</span> <span class="n">othermsgctxt</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">msgctxt</span> <span class="o">&lt;</span> <span class="n">othermsgctxt</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Compare msgid_plural</span>
        <span class="n">msgid_plural</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid_plural</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">othermsgid_plural</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgid_plural</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">msgid_plural</span> <span class="o">&gt;</span> <span class="n">othermsgid_plural</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">msgid_plural</span> <span class="o">&lt;</span> <span class="n">othermsgid_plural</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Compare msgstr_plural</span>
        <span class="n">msgstr_plural</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">othermsgstr_plural</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgstr_plural</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">msgstr_plural</span> <span class="o">&gt;</span> <span class="n">othermsgstr_plural</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">msgstr_plural</span> <span class="o">&lt;</span> <span class="n">othermsgstr_plural</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Compare msgid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">msgid</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">msgid</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Compare msgstr</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">msgstr</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">msgstr</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

<div class="viewcode-block" id="POEntry.translated"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POEntry.translated">[docs]</a>    <span class="k">def</span> <span class="nf">translated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``True`` if the entry has been translated or ``False``</span>
<span class="sd">        otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzy</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="POEntry.merge"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.POEntry.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge the current entry with the given pot entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgctxt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">occurrences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">comment</span>
        <span class="n">fuzzy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">flags</span><span class="p">[:]</span>  <span class="c1"># clone flags</span>
        <span class="k">if</span> <span class="n">fuzzy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fuzzy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgid_plural</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">msgid_plural</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsolete</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">obsolete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgctxt</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">previous_msgctxt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgid</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">previous_msgid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgid_plural</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">previous_msgid_plural</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># keep existing translation at pos if any</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fuzzy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;fuzzy&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msgid_with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msgctxt</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x04</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgid</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">msgid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span><span class="p">))</span></div>
<span class="c1"># }}}</span>
<span class="c1"># class MOEntry {{{</span>


<div class="viewcode-block" id="MOEntry"><a class="viewcode-back" href="../includes/0-thirdparty_docs.d/polib/api.html#polib.MOEntry">[docs]</a><span class="k">class</span> <span class="nc">MOEntry</span><span class="p">(</span><span class="n">_BaseEntry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a mo file entry.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor, accepts the following keyword arguments,</span>
<span class="sd">        for consistency with :class:`~polib.POEntry`:</span>

<span class="sd">        ``comment``</span>
<span class="sd">        ``tcomment``</span>
<span class="sd">        ``occurrences``</span>
<span class="sd">        ``flags``</span>
<span class="sd">        ``previous_msgctxt``</span>
<span class="sd">        ``previous_msgid``</span>
<span class="sd">        ``previous_msgid_plural``</span>

<span class="sd">        Note: even though these keyword arguments are accepted,</span>
<span class="sd">        they hold no real meaning in the context of MO files</span>
<span class="sd">        and are simply ignored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_BaseEntry</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tcomment</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occurrences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgctxt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_msgid_plural</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">msgid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msgstr</span><span class="p">))</span></div>

<span class="c1"># }}}</span>
<span class="c1"># class _POFileParser {{{</span>


<span class="k">class</span> <span class="nc">_POFileParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A finite state machine to parse efficiently and correctly po</span>
<span class="sd">    file format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pofile</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        ``pofile``</span>
<span class="sd">            string, path to the po file or its content</span>

<span class="sd">        ``encoding``</span>
<span class="sd">            string, the encoding to use, defaults to ``default_encoding``</span>
<span class="sd">            global variable (optional).</span>

<span class="sd">        ``check_for_duplicates``</span>
<span class="sd">            whether to check for duplicate entries when adding entries to the</span>
<span class="sd">            file (optional, default: ``False``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_is_file</span><span class="p">(</span><span class="n">pofile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pofile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="n">enc</span> <span class="o">=</span> <span class="n">default_encoding</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pofile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span> <span class="o">=</span> <span class="n">pofile</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="n">klass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="n">POFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span>
            <span class="n">pofile</span><span class="o">=</span><span class="n">pofile</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">enc</span><span class="p">,</span>
            <span class="n">check_for_duplicates</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_for_duplicates&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="s1">&#39;st&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># two memo flags used in handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_obsolete</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Configure the state machine, by adding transitions.</span>
        <span class="c1"># Signification of symbols:</span>
        <span class="c1">#     * ST: Beginning of the file (start)</span>
        <span class="c1">#     * HE: Header</span>
        <span class="c1">#     * TC: a translation comment</span>
        <span class="c1">#     * GC: a generated comment</span>
        <span class="c1">#     * OC: a file/line occurrence</span>
        <span class="c1">#     * FL: a flags line</span>
        <span class="c1">#     * CT: a message context</span>
        <span class="c1">#     * PC: a previous msgctxt</span>
        <span class="c1">#     * PM: a previous msgid</span>
        <span class="c1">#     * PP: a previous msgid_plural</span>
        <span class="c1">#     * MI: a msgid</span>
        <span class="c1">#     * MP: a msgid plural</span>
        <span class="c1">#     * MS: a msgstr</span>
        <span class="c1">#     * MX: a msgstr plural</span>
        <span class="c1">#     * MC: a msgid or msgstr continuation line</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">,</span> <span class="s1">&#39;he&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;oc&#39;</span><span class="p">,</span> <span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;tc&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mp&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="s1">&#39;mi&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">,</span> <span class="s1">&#39;he&#39;</span><span class="p">],</span>                                     <span class="s1">&#39;he&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;oc&#39;</span><span class="p">,</span> <span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;tc&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;mp&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="s1">&#39;mi&#39;</span><span class="p">],</span>                               <span class="s1">&#39;tc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span>                                              <span class="s1">&#39;gc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;oc&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span>                                              <span class="s1">&#39;oc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span>                                              <span class="s1">&#39;fl&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span>                                              <span class="s1">&#39;pc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span>                                              <span class="s1">&#39;pm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span>                                              <span class="s1">&#39;pp&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">,</span> <span class="s1">&#39;he&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;oc&#39;</span><span class="p">,</span> <span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;tc&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">],</span>                               <span class="s1">&#39;ct&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mi&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">,</span> <span class="s1">&#39;he&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;oc&#39;</span><span class="p">,</span> <span class="s1">&#39;fl&#39;</span><span class="p">,</span> <span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="s1">&#39;tc&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">],</span>                                <span class="s1">&#39;mi&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mp&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tc&#39;</span><span class="p">,</span> <span class="s1">&#39;gc&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;mi&#39;</span><span class="p">],</span>             <span class="s1">&#39;mp&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mi&#39;</span><span class="p">,</span> <span class="s1">&#39;mp&#39;</span><span class="p">,</span> <span class="s1">&#39;tc&#39;</span><span class="p">],</span>                               <span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mi&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="s1">&#39;mp&#39;</span><span class="p">,</span> <span class="s1">&#39;tc&#39;</span><span class="p">],</span>                         <span class="s1">&#39;mx&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">,</span> <span class="s1">&#39;mi&#39;</span><span class="p">,</span> <span class="s1">&#39;mp&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">,</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">],</span> <span class="s1">&#39;mc&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the state machine, parse the file line by line and call process()</span>
<span class="sd">        with the current matched symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;msgctxt&#39;</span><span class="p">:</span> <span class="s1">&#39;ct&#39;</span><span class="p">,</span>
            <span class="s1">&#39;msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;mi&#39;</span><span class="p">,</span>
            <span class="s1">&#39;msgstr&#39;</span><span class="p">:</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
            <span class="s1">&#39;msgid_plural&#39;</span><span class="p">:</span> <span class="s1">&#39;mp&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">prev_keywords</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;msgid_plural&#39;</span><span class="p">:</span> <span class="s1">&#39;pp&#39;</span><span class="p">,</span>
            <span class="s1">&#39;msgid&#39;</span><span class="p">:</span> <span class="s1">&#39;pm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;msgctxt&#39;</span><span class="p">:</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">fpath</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">fpath</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">nb_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#~|&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#~&#39;</span> <span class="ow">and</span> <span class="n">nb_tokens</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">nb_tokens</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entry_obsolete</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entry_obsolete</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Take care of keywords like</span>
            <span class="c1"># msgid, msgid_plural, msgctxt &amp; msgstr.</span>
            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">keywords</span> <span class="ow">and</span> <span class="n">nb_tokens</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^</span><span class="se">\\</span><span class="s1">]|^)&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file </span><span class="si">%s</span><span class="s1">(line </span><span class="si">%s</span><span class="s1">): &#39;</span>
                                  <span class="s1">&#39;unescaped double quote found&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span> <span class="o">=</span> <span class="n">line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span> <span class="o">=</span> <span class="n">line</span>

            <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#:&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nb_tokens</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># we are on a occurrences line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;oc&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">line</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">:</span>
                <span class="c1"># we are on a continuation line</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^</span><span class="se">\\</span><span class="s1">]|^)&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file </span><span class="si">%s</span><span class="s1">(line </span><span class="si">%s</span><span class="s1">): &#39;</span>
                                  <span class="s1">&#39;unescaped double quote found&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">line</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;msgstr[&#39;</span><span class="p">:</span>
                <span class="c1"># we are on a msgstr plural</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;mx&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#,&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nb_tokens</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># we are on a flags line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;fl&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;##&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
                <span class="c1"># we are on a translator comment line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;tc&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#.&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nb_tokens</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># we are on a generated comment line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;gc&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#|&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nb_tokens</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file </span><span class="si">%s</span><span class="s1">(line </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">))</span>

                <span class="c1"># Remove the marker and any whitespace right after that.</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span> <span class="o">=</span> <span class="n">line</span>

                <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="c1"># Continuation of previous metadata.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">nb_tokens</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Invalid continuation line.</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file </span><span class="si">%s</span><span class="s1">(line </span><span class="si">%s</span><span class="s1">): &#39;</span>
                                  <span class="s1">&#39;invalid continuation line&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">))</span>

                <span class="c1"># we are on a &quot;previous translation&quot; comment line,</span>
                <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prev_keywords</span><span class="p">:</span>
                    <span class="c1"># Unknown keyword in previous translation comment.</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file </span><span class="si">%s</span><span class="s1">(line </span><span class="si">%s</span><span class="s1">): &#39;</span>
                                  <span class="s1">&#39;unknown keyword </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">,</span>
                                   <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="c1"># Remove the keyword and any whitespace</span>
                <span class="c1"># between it and the starting quote.</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span> <span class="o">=</span> <span class="n">line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">prev_keywords</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file </span><span class="si">%s</span><span class="s1">(line </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> \
           <span class="ow">not</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="c1"># since entries are added when another entry is found, we must add</span>
            <span class="c1"># the last entry here (only if there are lines). Trailing comments</span>
            <span class="c1"># are ignored</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>

        <span class="c1"># before returning the instance, check if there&#39;s metadata and if</span>
        <span class="c1"># so extract it in a dict</span>
        <span class="n">metadataentry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadataentry</span><span class="p">:</span>  <span class="c1"># metadata found</span>
            <span class="c1"># remove the entry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">metadataentry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">metadata_is_fuzzy</span> <span class="o">=</span> <span class="n">metadataentry</span><span class="o">.</span><span class="n">flags</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">metadataentry</span><span class="o">.</span><span class="n">msgstr</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># close opened file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>  <span class="c1"># must be file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a transition to the state machine.</span>

<span class="sd">        Keywords arguments:</span>

<span class="sd">        ``symbol``</span>
<span class="sd">            string, the matched token (two chars symbol).</span>

<span class="sd">        ``states``</span>
<span class="sd">            list, a list of states (two chars symbols).</span>

<span class="sd">        ``next_state``</span>
<span class="sd">            the next state the fsm will have after the action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;handle_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">next_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">state</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">next_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the transition corresponding to the current state and the</span>
<span class="sd">        symbol provided.</span>

<span class="sd">        Keywords arguments:</span>

<span class="sd">        ``symbol``</span>
<span class="sd">            string, the matched token (two chars symbol).</span>

<span class="sd">        ``linenum``</span>
<span class="sd">            integer, the current line number of the parsed file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[(</span><span class="n">symbol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Syntax error in po file (line </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>

    <span class="c1"># state handlers</span>

    <span class="k">def</span> <span class="nf">handle_he</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a header comment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">header</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">handle_tc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a translator comment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">tcomment</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">tcomment</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">tcomment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tcomment</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
            <span class="n">tcomment</span> <span class="o">=</span> <span class="n">tcomment</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">tcomment</span> <span class="o">+=</span> <span class="n">tcomment</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_gc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a generated comment.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">comment</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_oc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a file:num occurrence.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="n">occurrences</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">occurrence</span> <span class="ow">in</span> <span class="n">occurrences</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">occurrence</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fil</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">occurrence</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">fil</span> <span class="o">=</span> <span class="n">occurrence</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">occurrences</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fil</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">occurrences</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">occurrence</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_fl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a flags line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">flags</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a previous msgid_plural line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">previous_msgid_plural</span> <span class="o">=</span> \
            <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_pm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a previous msgid line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">previous_msgid</span> <span class="o">=</span> \
            <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_pc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a previous msgctxt line.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">previous_msgctxt</span> <span class="o">=</span> \
            <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_ct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a msgctxt.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgctxt</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_mi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a msgid.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="s1">&#39;mx&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span> <span class="o">=</span> <span class="n">POEntry</span><span class="p">(</span><span class="n">linenum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">obsolete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_obsolete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgid</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a msgid plural.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgid_plural</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a msgstr.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_mx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a msgstr plural.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msgstr_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_mc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a msgid or msgstr continuation line.&quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">unescape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;ct&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgctxt</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;mi&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgid</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;mp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgid_plural</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgstr</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;mx&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">msgstr_plural</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">msgstr_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;pp&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">previous_msgid_plural</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;pm&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">previous_msgid</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="s1">&#39;pc&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_entry</span><span class="o">.</span><span class="n">previous_msgctxt</span> <span class="o">+=</span> <span class="n">token</span>
        <span class="c1"># don&#39;t change the current state</span>
        <span class="k">return</span> <span class="kc">False</span>
<span class="c1"># }}}</span>
<span class="c1"># class _MOFileParser {{{</span>


<span class="k">class</span> <span class="nc">_MOFileParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to parse binary mo files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mofile</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor.</span>

<span class="sd">        Keyword arguments:</span>

<span class="sd">        ``mofile``</span>
<span class="sd">            string, path to the mo file or its content</span>

<span class="sd">        ``encoding``</span>
<span class="sd">            string, the encoding to use, defaults to ``default_encoding``</span>
<span class="sd">            global variable (optional).</span>

<span class="sd">        ``check_for_duplicates``</span>
<span class="sd">            whether to check for duplicate entries when adding entries to the</span>
<span class="sd">            file (optional, default: ``False``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">mofile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>

        <span class="n">klass</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;klass&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">klass</span> <span class="o">=</span> <span class="n">MOFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span>
            <span class="n">fpath</span><span class="o">=</span><span class="n">mofile</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">),</span>
            <span class="n">check_for_duplicates</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_for_duplicates&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure the file is closed, this prevents warnings on unclosed file</span>
<span class="sd">        when running tests with python &gt;= 3.2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the instance with the file handle provided in the</span>
<span class="sd">        constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parse magic number</span>
        <span class="n">magic_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readbinary</span><span class="p">(</span><span class="s1">&#39;&lt;I&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">magic_number</span> <span class="o">==</span> <span class="n">MOFile</span><span class="o">.</span><span class="n">MAGIC</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="s1">&#39;&lt;II&#39;</span>
        <span class="k">elif</span> <span class="n">magic_number</span> <span class="o">==</span> <span class="n">MOFile</span><span class="o">.</span><span class="n">MAGIC_SWAPPED</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="s1">&#39;&gt;II&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Invalid mo file, magic number is incorrect !&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">magic_number</span> <span class="o">=</span> <span class="n">magic_number</span>
        <span class="c1"># parse the version number and the number of strings</span>
        <span class="n">version</span><span class="p">,</span> <span class="n">numofstrings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readbinary</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="c1"># from MO file format specs: &quot;A program seeing an unexpected major</span>
        <span class="c1"># revision number should stop reading the MO file entirely&quot;</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Invalid mo file, unexpected major revision number&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="c1"># original strings and translation strings hash table offset</span>
        <span class="n">msgids_hash_offset</span><span class="p">,</span> <span class="n">msgstrs_hash_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readbinary</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="c1"># move to msgid hash table and read length and offset of msgids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">msgids_hash_offset</span><span class="p">)</span>
        <span class="n">msgids_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numofstrings</span><span class="p">):</span>
            <span class="n">msgids_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_readbinary</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="c1"># move to msgstr hash table and read length and offset of msgstrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">msgstrs_hash_offset</span><span class="p">)</span>
        <span class="n">msgstrs_index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numofstrings</span><span class="p">):</span>
            <span class="n">msgstrs_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_readbinary</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="c1"># build entries</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">encoding</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numofstrings</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">msgids_index</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">msgid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">msgids_index</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">msgstrs_index</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">msgstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">msgstrs_index</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">msgid</span><span class="p">:</span>  <span class="c1"># metadata</span>
                <span class="n">raw_metadata</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">msgstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)),</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">raw_metadata</span><span class="p">:</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">b</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">k</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
                            <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="n">metadata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
                <span class="k">continue</span>
            <span class="c1"># test if we have a plural entry</span>
            <span class="n">msgid_tokens</span> <span class="o">=</span> <span class="n">msgid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgid_tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_entry</span><span class="p">(</span>
                    <span class="n">msgid</span><span class="o">=</span><span class="n">msgid_tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">msgid_plural</span><span class="o">=</span><span class="n">msgid_tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">msgstr_plural</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                       <span class="nb">enumerate</span><span class="p">(</span><span class="n">msgstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">))))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_entry</span><span class="p">(</span><span class="n">msgid</span><span class="o">=</span><span class="n">msgid</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="n">msgstr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="c1"># close opened file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>

    <span class="k">def</span> <span class="nf">_build_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msgid</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msgid_plural</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">msgstr_plural</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">msgctxt_msgid</span> <span class="o">=</span> <span class="n">msgid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x04</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">encoding</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgctxt_msgid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;msgctxt&#39;</span><span class="p">:</span> <span class="n">msgctxt_msgid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">),</span>
                <span class="s1">&#39;msgid&#39;</span><span class="p">:</span> <span class="n">msgctxt_msgid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;msgid&#39;</span><span class="p">:</span> <span class="n">msgid</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">msgstr</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;msgstr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msgstr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msgid_plural</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;msgid_plural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msgid_plural</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msgstr_plural</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">msgstr_plural</span><span class="p">:</span>
                <span class="n">msgstr_plural</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">msgstr_plural</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;msgstr_plural&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msgstr_plural</span>
        <span class="k">return</span> <span class="n">MOEntry</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_readbinary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method that unpack n bytes of data using format &lt;fmt&gt;.</span>
<span class="sd">        It returns a tuple or a mixed value if the tuple length is 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fhandle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">numbytes</span><span class="p">)</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tup</span>
<span class="c1"># }}}</span>
<span class="c1"># class TextWrapper {{{</span>


<span class="k">class</span> <span class="nc">TextWrapper</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">TextWrapper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Subclass of textwrap.TextWrapper that backport the</span>
<span class="sd">    drop_whitespace option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">drop_whitespace</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;drop_whitespace&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">textwrap</span><span class="o">.</span><span class="n">TextWrapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_whitespace</span> <span class="o">=</span> <span class="n">drop_whitespace</span>

    <span class="k">def</span> <span class="nf">_wrap_chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;_wrap_chunks(chunks : [string]) -&gt; [string]</span>

<span class="sd">        Wrap a sequence of text chunks and return a list of lines of</span>
<span class="sd">        length &#39;self.width&#39; or less.  (If &#39;break_long_words&#39; is false,</span>
<span class="sd">        some lines may be longer than this.)  Chunks correspond roughly</span>
<span class="sd">        to words and the whitespace between them: each chunk is</span>
<span class="sd">        indivisible (modulo &#39;break_long_words&#39;), but a line break can</span>
<span class="sd">        come between any two chunks.  Chunks should not have internal</span>
<span class="sd">        whitespace; ie. a chunk is either all whitespace or a &quot;word&quot;.</span>
<span class="sd">        Whitespace chunks will be removed from the beginning and end of</span>
<span class="sd">        lines, but apart from that whitespace is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid width </span><span class="si">%r</span><span class="s2"> (must be &gt; 0)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>

        <span class="c1"># Arrange in reverse order so items can be efficiently popped</span>
        <span class="c1"># from a stack of chucks.</span>
        <span class="n">chunks</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">chunks</span><span class="p">:</span>

            <span class="c1"># Start the list of chunks that will make up the current line.</span>
            <span class="c1"># cur_len is just the length of all the chunks in cur_line.</span>
            <span class="n">cur_line</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cur_len</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Figure out which static string will prefix this line.</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsequent_indent</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_indent</span>

            <span class="c1"># Maximum width for this line.</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span>

            <span class="c1"># First chunk on line is whitespace -- drop it, unless this</span>
            <span class="c1"># is the very beginning of the text (ie. no lines started yet).</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_whitespace</span> <span class="ow">and</span> <span class="n">chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">while</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># Can at least squeeze this chunk onto the current line.</span>
                <span class="k">if</span> <span class="n">cur_len</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">:</span>
                    <span class="n">cur_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunks</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                    <span class="n">cur_len</span> <span class="o">+=</span> <span class="n">length</span>

                <span class="c1"># Nope, this line is full.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># The current line is full, and the next chunk is too big to</span>
            <span class="c1"># fit on *any* line (not just this one).</span>
            <span class="k">if</span> <span class="n">chunks</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_long_word</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">cur_line</span><span class="p">,</span> <span class="n">cur_len</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

            <span class="c1"># If the last chunk on this line is all whitespace, drop it.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_whitespace</span> <span class="ow">and</span> <span class="n">cur_line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cur_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">del</span> <span class="n">cur_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Convert current line back to a string and store it in list</span>
            <span class="c1"># of all lines (return value).</span>
            <span class="k">if</span> <span class="n">cur_line</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cur_line</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">lines</span>
<span class="c1"># }}}</span>
<span class="c1"># function wrap() {{{</span>


<span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrap a single paragraph of text, returning a list of wrapped lines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TextWrapper</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1"># }}}</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2018, Odyseus.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a modified version of <a href="https://github.com/rtfd/sphinx_rtd_theme">sphinx-rtd-theme</a>. 

</footer>

        </div>
      </div>

      <a id="to-top-of-page" href="#top">
        <i class="fa fa-chevron-circle-up"></i>
      </a>

    </section>

  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.min.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>