

<!DOCTYPE html>
<html class="no-js" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HostsManagerApp.app_utils &mdash; Python CLI Applications Documentations  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/python-logo.svg"/>
  
  
  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: False" >
          

          
            <a href="../../index.html" class="icon icon-home"> Python CLI Applications Documentations
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../includes/1-general-notes.html">General development notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/CLIApplicationsManager/index.html"><abbr title="Command Line Interface">CLI</abbr> applications manager's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/BackupUtils/index.html">Backup Utils' documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/BootstrapThemesGenerator/index.html">Bootstrap Themes Generator' documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/ChrootHelper/index.html">Chroot Helpers's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/FilesCleaner/index.html">Files Cleaner's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/HostsManager/index.html">Hosts Manager's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/JSONSchemaValidator/index.html">JSON Schema Validator's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/KnowledgeBase/index.html">Knowledge Base's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/MakeCinnamonXletPOT/index.html">Make Cinnamon Xlet POT's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/MoviesDB/index.html">Movies DB's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/PackageManager/index.html">Package Manager's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/UserApplicationsManager/index.html">User Applications Manager's documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../includes/0-thirdparty_docs.d/docopt.html">docopt's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/0-thirdparty_docs.d/polib/index.html">polib's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/0-thirdparty_docs.d/pyperclip/index.html">pyperclip's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/0-thirdparty_docs.d/titlecase.html">titlecase's documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../includes/0-thirdparty_docs.d/tqdm.html">tqdm</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python CLI Applications Documentations</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>HostsManagerApp.app_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for HostsManagerApp.app_utils</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Module with utility functions and classes.</span>

<span class="sd">Attributes</span>
<span class="sd">----------</span>
<span class="sd">root_folder : str</span>
<span class="sd">    The main folder containing the application. All commands must be executed from this location</span>
<span class="sd">    without exceptions.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">ipaddress</span> <span class="k">import</span> <span class="n">ip_address</span>
<span class="kn">from</span> <span class="nn">runpy</span> <span class="k">import</span> <span class="n">run_path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">copy2</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="k">import</span> <span class="n">gethostname</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">CalledProcessError</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">STDOUT</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="k">import</span> <span class="n">NamedTemporaryFile</span>

<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">cmd_utils</span>
<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">file_utils</span>
<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">json_schema_utils</span>
<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">shell_utils</span>
<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">string_utils</span>
<span class="kn">from</span> <span class="nn">.python_utils</span> <span class="k">import</span> <span class="n">tqdm_wget</span>
<span class="kn">from</span> <span class="nn">.python_utils.ansi_colors</span> <span class="k">import</span> <span class="n">Ansi</span>
<span class="kn">from</span> <span class="nn">.python_utils.tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">.schemas</span> <span class="k">import</span> <span class="n">settings_schema</span>
<span class="kn">from</span> <span class="nn">.schemas</span> <span class="k">import</span> <span class="n">sources_schema</span>

<span class="kn">from</span> <span class="nn">.pre_processors</span> <span class="k">import</span> <span class="n">pre_processors</span> <span class="k">as</span> <span class="n">builtin_pre_processors</span>


<span class="n">root_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()))))</span>

<span class="n">_hostname_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?!-)[\w-]{1,63}(?&lt;!-)$&quot;</span><span class="p">)</span>
<span class="n">_invalid_ip_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid IP address.&quot;</span>
<span class="n">_invalid_integer_msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid integer.&quot;</span>
<span class="n">_profiles_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s2">&quot;UserData&quot;</span><span class="p">,</span> <span class="s2">&quot;profiles&quot;</span><span class="p">)</span>
<span class="n">_user_data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s2">&quot;UserData&quot;</span><span class="p">)</span>
<span class="n">_invalid_rule</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<span class="n">_tar_allowed_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;--xz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-J&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--gzip&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--bzip2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;-j&quot;</span>
<span class="p">}</span>
<span class="n">_header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# Date: </span><span class="si">{date}</span><span class="s2"></span>
<span class="s2"># Number of unique domains: </span><span class="si">{number_of_rules}</span><span class="s2"></span>
<span class="s2"># ===============================================================</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">_header_static_hosts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">0.0.0.0 0.0.0.0</span>
<span class="s2">127.0.0.1 local</span>
<span class="s2">127.0.0.1 localhost</span>
<span class="s2">127.0.0.1 localhost.localdomain</span>
<span class="s2">127.0.0.53 </span><span class="si">{host_name}</span><span class="s2"></span>
<span class="s2">127.0.1.1 </span><span class="si">{host_name}</span><span class="s2"></span>
<span class="s2">255.255.255.255 broadcasthost</span>
<span class="s2">::1 ip6-localhost</span>
<span class="s2">::1 ip6-loopback</span>
<span class="s2">::1 localhost</span>
<span class="s2">fe80::1</span><span class="si">%lo</span><span class="s2">0 localhost</span>
<span class="s2">ff00::0 ip6-localnet</span>
<span class="s2">ff00::0 ip6-mcastprefix</span>
<span class="s2">ff02::1 ip6-allnodes</span>
<span class="s2">ff02::2 ip6-allrouters</span>
<span class="s2">ff02::3 ip6-allhosts</span>

<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="OverridesValidator"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.OverridesValidator">[docs]</a><span class="k">class</span> <span class="nc">OverridesValidator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate a list of settings passed as arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_valid_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;target_ip&quot;</span><span class="p">,</span>
        <span class="s2">&quot;keep_domain_comments&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skip_static_hosts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;custom_static_hosts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;backup_old_generated_hosts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;backup_system_hosts&quot;</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_overrides</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raw_overrides : list</span>
<span class="sd">            The raw list of settings as passed to the CLI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_overrides</span> <span class="o">=</span> <span class="n">raw_overrides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_valid_overrides</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_overrides</span><span class="p">()</span>

<div class="viewcode-block" id="OverridesValidator.get_valid_overrides"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.OverridesValidator.get_valid_overrides">[docs]</a>    <span class="k">def</span> <span class="nf">get_valid_overrides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get valid overrides.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            The final list of settings validated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_overrides</span></div>

<div class="viewcode-block" id="OverridesValidator.get_errors"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.OverridesValidator.get_errors">[docs]</a>    <span class="k">def</span> <span class="nf">get_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get validation errors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of validation errors to be displayed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span></div>

<div class="viewcode-block" id="OverridesValidator._validate_overrides"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.OverridesValidator._validate_overrides">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_overrides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate the raw overrides.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">raw_override</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_overrides</span><span class="p">:</span>
            <span class="n">override</span> <span class="o">=</span> <span class="n">raw_override</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">override</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Wrong override format: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span>
                                    <span class="n">raw_override</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;Correct format: &#39;key=value&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">override</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_settings</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Wrong key name: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;target_ip&quot;</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_invalid_ip_msg</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;max_backups_to_keep&quot;</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_invalid_integer_msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Valid Boolean values are: true, 1, false or 0. (case insensitive)&quot;</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;target_ip&quot;</span> <span class="ow">and</span> <span class="n">is_valid_ip</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_valid_overrides</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;max_backups_to_keep&quot;</span> <span class="ow">and</span> <span class="n">is_valid_integer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_valid_overrides</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_bool</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_valid_overrides</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Wrong value for: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">raw_override</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">error_msg</span><span class="p">)</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="OverridesValidator._validate_bool"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.OverridesValidator._validate_bool">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate Boolean.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : str</span>
<span class="sd">            The key value to validate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            If it is a valid value for a Boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="OverridesValidator._get_bool"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.OverridesValidator._get_bool">[docs]</a>    <span class="k">def</span> <span class="nf">_get_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a Boolean.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : str</span>
<span class="sd">            The key value already validated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            The Boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="HostsManager"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager">[docs]</a><span class="k">class</span> <span class="nc">HostsManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HostsManager class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    logger : object</span>
<span class="sd">        See &lt;class :any:`LogSystem`&gt;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">settings_overrides</span><span class="o">=</span><span class="p">{},</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile : str, optional</span>
<span class="sd">            The profile name.</span>
<span class="sd">        dry_run : bool, optional</span>
<span class="sd">            Log an action without actually performing it.</span>
<span class="sd">        settings_overrides : dict, optional</span>
<span class="sd">            A list of settings to override the default ones or the defined in the profile&#39;s</span>
<span class="sd">            configuration file.</span>
<span class="sd">        logger : object</span>
<span class="sd">            See &lt;class :any:`LogSystem`&gt;.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.MissingConfigFileForProfile</span>
<span class="sd">            See &lt;class :any:`exceptions.MissingConfigFileForProfile`&gt;.</span>
<span class="sd">        exceptions.NoProfileNameProvided</span>
<span class="sd">            See &lt;class :any:`exceptions.NoProfileNameProvided`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NoProfileNameProvided</span><span class="p">(</span><span class="s2">&quot;No profile name was provided.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_whitelist_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2"> %Y&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>  <span class="c1"># Format = January 1 2018</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_profiles_path</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">run_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;conf.py&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">MissingConfigFileForProfile</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">config_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_sources</span><span class="p">()</span>

        <span class="c1"># Customizable settings.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;target_ip&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;keep_domain_comments&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;skip_static_hosts&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;custom_static_hosts&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;backup_old_generated_hosts&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;backup_system_hosts&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;max_backups_to_keep&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">profile_settings</span> <span class="o">=</span> <span class="n">config_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;settings&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">profile_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings_overrides</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profile_settings</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Changing self._exclusions from a list to a set improved items iterations</span>
        <span class="c1"># from ~50.000 it/s to ~75.000 it/s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compressed_sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_rules</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_ignores</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_backups_to_keep</span> <span class="o">=</span> <span class="n">profile_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_backups_to_keep&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_option_keys</span><span class="p">()</span>

        <span class="c1"># Paths to files/folders.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;hosts&quot;</span><span class="p">)</span>
        <span class="n">sources_storage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;sources_storage&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_storage</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_compressed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sources_storage</span><span class="p">,</span> <span class="s2">&quot;compressed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sources_last_updated</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;last_updated.json&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;backups_storage&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_whitelist_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;whitelist&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_whitelist_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_user_data_path</span><span class="p">,</span> <span class="s2">&quot;global_whitelist&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_blacklist_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;blacklist&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_blacklist_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_user_data_path</span><span class="p">,</span> <span class="s2">&quot;global_blacklist&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_paths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_local_sources_data</span><span class="p">()</span>

<div class="viewcode-block" id="HostsManager._log_shell_separator"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._log_shell_separator">[docs]</a>    <span class="k">def</span> <span class="nf">_log_shell_separator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summary</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        char : str, optional</span>
<span class="sd">            Character used to generate the &quot;CLI separator&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">shell_utils</span><span class="o">.</span><span class="n">get_cli_separator</span><span class="p">(</span><span class="n">char</span><span class="p">),</span> <span class="n">date</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="HostsManager._validate_sources"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._validate_sources">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate sources.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.MalformedSources</span>
<span class="sd">            See &lt;class :any:`exceptions.MalformedSources`&gt;.</span>
<span class="sd">        exceptions.MissingSourcesOnConfigFile</span>
<span class="sd">            See &lt;class :any:`exceptions.MissingSourcesOnConfigFile`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">MissingSourcesOnConfigFile</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;sources&#39; variable is not declared or it&#39;s empty.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">json_schema_utils</span><span class="o">.</span><span class="n">JSONSCHEMA_INSTALLED</span><span class="p">:</span>
            <span class="n">json_schema_utils</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">,</span> <span class="n">sources_schema</span><span class="p">,</span>
                <span class="n">error_message_extra_info</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="s2">&quot;File: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;conf.py&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;Data key: sources&quot;</span>
                <span class="p">]),</span>
                <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># TODO: Find a way to validate the following using JSON schema.</span>
        <span class="c1"># This doesn&#39;t seem possible with current JSON schema standards.</span>
        <span class="c1"># Checked up to daft 4 of the JSON schema standard.</span>
        <span class="c1"># Revisit when the stable version of the jsonschema module implements</span>
        <span class="c1"># the draft 7 of the standard.</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_name</span><span class="p">:</span>
                <span class="c1"># Do not allow more than one source with the same &quot;name&quot;.</span>
                <span class="k">if</span> <span class="n">source_name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;More than one source with the same name. &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">source_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">MalformedSources</span><span class="p">(</span>
                <span class="s2">&quot;Error/s found that must be fixed!!!</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span></div>

<div class="viewcode-block" id="HostsManager._expand_local_sources_data"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._expand_local_sources_data">[docs]</a>    <span class="k">def</span> <span class="nf">_expand_local_sources_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add additional data to the sources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_last_updated</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
            <span class="c1"># Generate and add &quot;slugified_name&quot;.</span>
            <span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hosts-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">string_utils</span><span class="o">.</span><span class="n">slugify</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

            <span class="c1"># Generate and add the path for the downloaded file.</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_compressed</span><span class="p">,</span>
                                 <span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">],</span>
                                 <span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">])</span>

            <span class="c1"># Insert the date in which the source was last updated.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span><span class="p">:</span>
                <span class="n">source</span><span class="p">[</span><span class="s2">&quot;last_updated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Lastly, sort dictionaries by source names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="HostsManager._validate_option_keys"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._validate_option_keys">[docs]</a>    <span class="k">def</span> <span class="nf">_validate_option_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_schema_utils</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">,</span> <span class="n">settings_schema</span><span class="p">,</span>
            <span class="n">error_message_extra_info</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s2">&quot;File: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_path</span><span class="p">,</span> <span class="s2">&quot;conf.py&quot;</span><span class="p">),</span>
                <span class="s2">&quot;Data key: settings&quot;</span>
            <span class="p">]),</span>
            <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span></div>

<div class="viewcode-block" id="HostsManager.install_hosts_file"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager.install_hosts_file">[docs]</a>    <span class="k">def</span> <span class="nf">install_hosts_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Install the generated hosts file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_shell_separator</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">Ansi</span><span class="o">.</span><span class="n">LIGHT_MAGENTA</span><span class="p">(</span><span class="s2">&quot;Moving the hosts file requires administrative privileges.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;You might need to enter your password.&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;backup_system_hosts&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backing up the system&#39;s hosts file...&quot;</span><span class="p">)</span>
                <span class="n">backup_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">,</span> <span class="s2">&quot;system-hosts-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%H-%M-%S&quot;</span><span class="p">)))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;The file at /etc/hosts will be backed up into:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                                            <span class="o">%</span> <span class="n">backup_file_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Surplus files will be removed inside the folder:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                                            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">copy2</span><span class="p">(</span><span class="s2">&quot;/etc/hosts&quot;</span><span class="p">,</span> <span class="n">backup_file_path</span><span class="p">)</span>
                    <span class="n">file_utils</span><span class="o">.</span><span class="n">remove_surplus_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">,</span> <span class="s2">&quot;system-hosts-*&quot;</span><span class="p">,</span>
                                                    <span class="n">max_files_to_keep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;max_backups_to_keep&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_install_hosts_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager.build_hosts_file"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager.build_hosts_file">[docs]</a>    <span class="k">def</span> <span class="nf">build_hosts_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the hosts file from the local sources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_shell_separator</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_create_temporary_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_old_hosts_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_exclusions_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_final_file</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_opening_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hosts file building finished.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;It contains </span><span class="si">{:,}</span><span class="s2"> unique entries.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_of_rules</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_ignores</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;A total of </span><span class="si">{:,}</span><span class="s2"> rules were ignored.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_of_ignores</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;(Ignored rules are listed inside the log file)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HostsManager.update_all_sources"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager.update_all_sources">[docs]</a>    <span class="k">def</span> <span class="nf">update_all_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_update</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update all host files, regardless of folder depth.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force_update : bool</span>
<span class="sd">            Ignore source update frequency and update its file/s anyway.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.KeyboardInterruption</span>
<span class="sd">            See &lt;class :any:`exceptions.KeyboardInterruption`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_shell_separator</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating sources...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_update</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;The following directory will be removed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_compressed</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">)</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_compressed</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_shell_separator</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">force_update</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_update_source</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating source &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_download_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error in updating source. URL: &quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeyboardInterruption</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Source &lt;</span><span class="si">%s</span><span class="s2">&gt; doesn&#39;t need updating.&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeyboardInterruption</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Last update data for sources will be saved at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_sources_last_updated</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_last_updated</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
                    <span class="n">data_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed_sources</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_compressed_sources</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager._should_update_source"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._should_update_source">[docs]</a>    <span class="k">def</span> <span class="nf">_should_update_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if source should be updated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : dict</span>
<span class="sd">            The source to check.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            If the source needs to be updated depending on its configured specified</span>
<span class="sd">            update frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">)</span>
        <span class="n">last_updated</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_updated&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">last_updated</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">downloaded_filename</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">downloaded_filename_exists</span> <span class="o">=</span> <span class="n">downloaded_filename</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">downloaded_filename</span><span class="p">)</span>

        <span class="c1"># Check separated to avoid unnecessary file existence checks.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">downloaded_filename_exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">then</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">last_updated</span><span class="p">,</span> <span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2"> %Y&quot;</span><span class="p">)</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span><span class="p">,</span> <span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2"> %Y&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>  <span class="c1"># Weekly.</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">then</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">frequency</span> <span class="o">==</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span>  <span class="c1"># Monthly.</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">then</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">frequency</span> <span class="o">==</span> <span class="s2">&quot;s&quot;</span><span class="p">:</span>  <span class="c1"># Semestrial.</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">then</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">87</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HostsManager._install_hosts_file"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._install_hosts_file">[docs]</a>    <span class="k">def</span> <span class="nf">_install_hosts_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy the newly-created hosts file into its correct location on the OS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Installing hosts file...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/sudo&quot;</span><span class="p">,</span> <span class="s2">&quot;cp&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">,</span> <span class="s2">&quot;/etc/hosts&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Copying the file failed.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Hosts file successfully installed.&quot;</span><span class="p">)</span>

            <span class="n">forget_credentials_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/sudo&quot;</span><span class="p">,</span> <span class="s2">&quot;-K&quot;</span><span class="p">]</span>
            <span class="n">forget_credentials_msg</span> <span class="o">=</span> <span class="s2">&quot;Removing cached sudo credentials </span><span class="si">{result}</span><span class="s2">.&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forget_credentials_cmd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">forget_credentials_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">forget_credentials_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">forget_credentials_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;There doesn&#39;t seem to be a generated hosts file.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HostsManager._download_source"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._download_source">[docs]</a>    <span class="k">def</span> <span class="nf">_download_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download the source files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : dict</span>
<span class="sd">            The source data.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.KeyboardInterruption</span>
<span class="sd">            See &lt;class :any:`exceptions.KeyboardInterruption`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_compressed_source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">)</span>

        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_utils</span><span class="o">.</span><span class="n">is_real_dir</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Directory will be created at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parent_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;File will be downloaded:&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;URL: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Location: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tqdm_wget</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeyboardInterruption</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_last_update_data</span><span class="p">[</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span>

            <span class="k">if</span> <span class="n">is_compressed_source</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compressed_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></div>

<div class="viewcode-block" id="HostsManager._handle_compressed_sources"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._handle_compressed_sources">[docs]</a>    <span class="k">def</span> <span class="nf">_handle_compressed_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle the downloaded sources with compressed files.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.KeyboardInterruption</span>
<span class="sd">            See &lt;class :any:`exceptions.KeyboardInterruption`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_shell_separator</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Handling compressed sources...&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compressed_sources</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_shell_separator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Decompressing source &lt;</span><span class="si">%s</span><span class="s2">&gt;.&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

                <span class="n">aborted_msg</span> <span class="o">=</span> <span class="s2">&quot;Extract operation for &lt;</span><span class="si">%s</span><span class="s2">&gt; aborted.&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">src_dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">])</span>
                <span class="n">src_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_dir_path</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;unzip_target&quot;</span><span class="p">])</span>
                <span class="n">dst_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">,</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">]))</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Command &lt;</span><span class="si">%s</span><span class="s2">&gt; not found on your system.&quot;</span> <span class="o">%</span>
                                      <span class="n">source</span><span class="p">[</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">aborted_msg</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;7z&quot;</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;7z&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unzip&quot;</span><span class="p">:</span>
                    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;unzip&quot;</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;unzip_prog&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;tar&quot;</span><span class="p">:</span>
                    <span class="n">untar_arg</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;untar_arg&quot;</span><span class="p">)</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tar&quot;</span><span class="p">,</span> <span class="s2">&quot;--extract&quot;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">untar_arg</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">untar_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_tar_allowed_args</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;untar_arg key ignored!&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Allowed arguments are:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_tar_allowed_args</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">untar_arg</span><span class="p">]</span>

                    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span>
                        <span class="s2">&quot;--file&quot;</span><span class="p">,</span>
                        <span class="n">source</span><span class="p">[</span><span class="s2">&quot;downloaded_filename&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;--totals&quot;</span>
                    <span class="p">]</span>

                <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span>
                                <span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running command:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>

                            <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
                                              <span class="n">stderr</span><span class="o">=</span><span class="n">STDOUT</span><span class="p">,</span>
                                              <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">cwd</span><span class="o">=</span><span class="n">src_dir_path</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst_path</span><span class="p">):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;File will be removed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                                                        <span class="o">%</span> <span class="n">dst_path</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dst_path</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;File will be copied:&quot;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Source: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">src_path</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;Destination: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dst_path</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">copy2</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dst_path</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err1</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">except</span> <span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">err2</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err2</span><span class="p">)</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeyboardInterruption</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager._write_opening_header"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._write_opening_header">[docs]</a>    <span class="k">def</span> <span class="nf">_write_opening_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the header information into the newly-created hosts file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing the opening header...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Reset file pointer.</span>
        <span class="n">file_contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>  <span class="c1"># Store content.</span>
        <span class="n">file_contents</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort content.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Write at the top.</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">_header</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_date</span><span class="p">,</span>
            <span class="n">number_of_rules</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:,}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_of_rules</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;skip_static_hosts&quot;</span><span class="p">]:</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="n">_header_static_hosts</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host_name</span><span class="o">=</span><span class="n">gethostname</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;custom_static_hosts&quot;</span><span class="p">]:</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;custom_static_hosts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host_name</span><span class="o">=</span><span class="n">gethostname</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">file_contents</span><span class="p">)</span>

        <span class="n">base_msg</span> <span class="o">=</span> <span class="s2">&quot;Newly generated hosts file at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span>
                <span class="s2">&quot;The following temporary file will not be automatically deleted:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="n">base_msg</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">base_msg</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager._remove_old_hosts_file"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._remove_old_hosts_file">[docs]</a>    <span class="k">def</span> <span class="nf">_remove_old_hosts_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the old generated hosts file.</span>

<span class="sd">        This is a hotfix because merging with an already existing hosts file leads</span>
<span class="sd">        to artifacts and duplicates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing old generated hosts file...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;The following actions will be performed at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">,</span>
                                        <span class="s2">&quot;- Back up the file if the appropriate option is enabled.&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;- Remove the file if it exists.&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;- And finally create an empty file.&quot;</span>
                                    <span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create if already removed, so remove won&#39;t raise an error.</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;backup_old_generated_hosts&quot;</span><span class="p">]:</span>
                <span class="n">backup_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">,</span> <span class="s2">&quot;generated-hosts-</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">-%H-%M-%S&quot;</span><span class="p">)))</span>

                <span class="c1"># Make a backup copy, marking the date in which the list was updated</span>
                <span class="n">copy2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">,</span> <span class="n">backup_file_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Old generated hosts file backed up...&quot;</span><span class="p">)</span>
                <span class="n">file_utils</span><span class="o">.</span><span class="n">remove_surplus_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">,</span> <span class="s2">&quot;generated-hosts-*&quot;</span><span class="p">,</span>
                                                <span class="n">max_files_to_keep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;max_backups_to_keep&quot;</span><span class="p">])</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Old generated hosts file removed...&quot;</span><span class="p">)</span>

            <span class="c1"># Create new empty hosts file</span>
            <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager._ensure_paths"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._ensure_paths">[docs]</a>    <span class="k">def</span> <span class="nf">_ensure_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure the existence of some folders inside the profile folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_dry_run</span><span class="p">(</span><span class="s2">&quot;The following directories will be created:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_compressed</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_compressed</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backups_storage</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="HostsManager._create_temporary_files"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._create_temporary_files">[docs]</a>    <span class="k">def</span> <span class="nf">_create_temporary_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create temporary files.</span>

<span class="sd">        Initialize the files in which all source files will be merged for later pruning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_whitelist_file</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating initial temporary file...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Collecting data from raw sources...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">))):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources_storage_raw</span><span class="p">,</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;slugified_name&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
                <span class="n">source_data</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Deal only with UTF-8 and cp1252 encodings.</span>
                <span class="c1"># If a source with any other encoding is found, FORGET OF ITS EXISTENCE!!!</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">curFile</span><span class="p">:</span>
                        <span class="n">source_data</span> <span class="o">=</span> <span class="n">curFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;cp1252&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">curFile</span><span class="p">:</span>
                            <span class="n">source_data</span> <span class="o">=</span> <span class="n">curFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Attempt to open file with cp1252 encoding failed.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;File ignored.&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="k">continue</span>

                <span class="k">if</span> <span class="n">source_data</span><span class="p">:</span>
                    <span class="n">source_data</span> <span class="o">=</span> <span class="n">source_data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pre_processors&quot;</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pre_processors&quot;</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
                                    <span class="n">pp_qual_name</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="vm">__qualname__</span>
                                    <span class="n">source_data</span> <span class="o">=</span> <span class="n">pp</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">builtin_pre_processors</span><span class="p">:</span>
                                    <span class="n">builtin_pre_pro</span> <span class="o">=</span> <span class="n">builtin_pre_processors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
                                    <span class="n">pp_qual_name</span> <span class="o">=</span> <span class="n">builtin_pre_pro</span><span class="o">.</span><span class="vm">__qualname__</span>
                                    <span class="n">source_data</span> <span class="o">=</span> <span class="n">builtin_pre_pro</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="c1"># Log the pre-processor function&#39;s qualified name.</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Pre-processor error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp_qual_name</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                                <span class="k">continue</span>

                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="s2">&quot;_merge_whitelist_file&quot;</span>
                            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_whitelist&quot;</span><span class="p">)</span> <span class="k">else</span>
                            <span class="s2">&quot;_merge_blacklist_file&quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">source_data</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Collecting data from blacklist files...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">blacklist_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_blacklist_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_blacklist_path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">blacklist_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding data from &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">blacklist_file</span><span class="p">,</span> <span class="n">_user_data_path</span><span class="p">))</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">blacklist_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">curFile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">curFile</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="HostsManager._populate_exclusions_list"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._populate_exclusions_list">[docs]</a>    <span class="k">def</span> <span class="nf">_populate_exclusions_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate exclusions list.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.KeyboardInterruption</span>
<span class="sd">            See &lt;class :any:`exceptions.KeyboardInterruption`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Populating the exclusions list...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing local whitelist files...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">whitelist_file</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_whitelist_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_whitelist_path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">whitelist_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding data from &lt;</span><span class="si">%s</span><span class="s2">&gt;...&quot;</span> <span class="o">%</span>
                                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">whitelist_file</span><span class="p">,</span> <span class="n">_user_data_path</span><span class="p">))</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">whitelist_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ins</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ins</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\t\n\r</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing whitelist sources...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_whitelist_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># reset file pointer</span>
        <span class="n">merge_whitelist_file_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_whitelist_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merge_whitelist_file_lines</span><span class="p">))):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">merge_whitelist_file_lines</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;::1&quot;</span><span class="p">:</span>
                    <span class="n">target_ip</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_rule</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">hostname</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_merge_whitelist_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeyboardInterruption</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_whitelist_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager._populate_final_file"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._populate_final_file">[docs]</a>    <span class="k">def</span> <span class="nf">_populate_final_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Populate the final hosts file.</span>

<span class="sd">        Remove duplicates and remove hosts that we are excluding.</span>

<span class="sd">        We check for duplicate host names as well as remove any host names that</span>
<span class="sd">        have been explicitly excluded by the user.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        exceptions.KeyboardInterruption</span>
<span class="sd">            See &lt;class :any:`exceptions.KeyboardInterruption`&gt;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Populating the new generated hosts file...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;generated-hosts-file-&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hosts_file_path</span><span class="p">,</span> <span class="s2">&quot;w+b&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># reset file pointer</span>

        <span class="n">hostnames</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;0.0.0.0&quot;</span>
            <span class="s2">&quot;broadcasthost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-allhosts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-allnodes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-allrouters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-localhost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-localnet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-loopback&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ip6-mcastprefix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;local&quot;</span><span class="p">,</span>
            <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;localhost.localdomain&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">cache_size</span> <span class="o">=</span> <span class="mi">250000</span>
        <span class="n">cache_storage</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">merge_blacklist_file_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">processed_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merge_blacklist_file_lines</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding rules to the final hosts file...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># DO NOT USE &quot;continue&quot; INSIDE THIS LOOP!!!</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merge_blacklist_file_lines</span><span class="p">))):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">merge_blacklist_file_lines</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">processed_lines</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">normalized_rule</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="c1"># Do not use continue. This is to avoid exiting the loop</span>
                <span class="c1"># while there is still data stored inside cache_storage.</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;::1&quot;</span><span class="p">:</span>
                    <span class="c1"># Normalize rule.</span>
                    <span class="n">target_ip</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_rule</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                    <span class="c1"># Changing self._exclusions from a list to a set improved items</span>
                    <span class="c1"># iterations from ~50.000 it/s to ~75.000 it/s.</span>
                    <span class="k">if</span> <span class="n">hostname</span> <span class="ow">and</span> <span class="n">hostname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclusions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comment</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;keep_domain_comments&quot;</span><span class="p">]:</span>
                            <span class="n">normalized_rule</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">normalized_rule</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">normalized_rule</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hostname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hostnames</span><span class="p">):</span>
                            <span class="n">cache_size</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="n">cache_storage</span> <span class="o">+=</span> <span class="n">normalized_rule</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">hostnames</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_rules</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">cache_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cache_storage</span><span class="p">)</span> <span class="ow">or</span> <span class="n">processed_lines</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_final_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">cache_storage</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
                    <span class="n">cache_storage</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">cache_size</span> <span class="o">=</span> <span class="mi">250000</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">KeyboardInterruption</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_merge_blacklist_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="HostsManager._normalize_rule"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.HostsManager._normalize_rule">[docs]</a>    <span class="k">def</span> <span class="nf">_normalize_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Standardize and format the rule string provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line : str</span>
<span class="sd">            The line to be standardized.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            The rules elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stripped_rule</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">stripped_rule</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s2">&quot;&quot;</span>

        <span class="n">rule_parts</span> <span class="o">=</span> <span class="n">stripped_rule</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># In &quot;ip host&quot; format. Most likely a line from a file in hosts format.</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="n">rule_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># In &quot;host&quot; format. Most likely a line for a file with a list of domains.</span>
                <span class="n">hostname</span> <span class="o">=</span> <span class="n">rule_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">hostname</span> <span class="ow">and</span> <span class="n">is_valid_host</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">[</span><span class="s2">&quot;target_ip&quot;</span><span class="p">],</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">comment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_of_ignores</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignored line: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_invalid_rule</span></div></div>


<div class="viewcode-block" id="is_valid_host"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.is_valid_host">[docs]</a><span class="k">def</span> <span class="nf">is_valid_host</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;IDN compatible domain validation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    host : str</span>
<span class="sd">        The host name to check.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether the host name is valid or not.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Based on: `Validate-a-hostname-string \</span>
<span class="sd">    &lt;https://stackoverflow.com/questions/2532053/validate-a-hostname-string&gt;`__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">253</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">_hostname_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)])</span></div>


<div class="viewcode-block" id="is_valid_ip"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.is_valid_ip">[docs]</a><span class="k">def</span> <span class="nf">is_valid_ip</span><span class="p">(</span><span class="n">address</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate IP address (IPv4 or IPv6).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    address : str</span>
<span class="sd">        The IP address to validate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        If it is a valid IP address or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ip_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="is_valid_integer"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.is_valid_integer">[docs]</a><span class="k">def</span> <span class="nf">is_valid_integer</span><span class="p">(</span><span class="n">integer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate integer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    integer : str</span>
<span class="sd">        The string to validate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        If the value is a valid integer or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">integer</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span></div>


<div class="viewcode-block" id="flush_dns_cache"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.flush_dns_cache">[docs]</a><span class="k">def</span> <span class="nf">flush_dns_cache</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Flush the DNS cache.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dry_run : bool, optional</span>
<span class="sd">        Log an action without actually performing it.</span>
<span class="sd">    logger : object</span>
<span class="sd">        See &lt;class :any:`LogSystem`&gt;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">Ansi</span><span class="o">.</span><span class="n">LIGHT_MAGENTA</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Flushing the DNS cache to utilize new hosts file...</span>
<span class="s2">Flushing the DNS cache requires administrative privileges.</span>
<span class="s2">You will need to enter your password.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">))</span>

    <span class="n">dns_cache_found</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">nscd_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/etc&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/rc.d&quot;</span><span class="p">]</span>
    <span class="n">nscd_msg</span> <span class="o">=</span> <span class="s2">&quot;Flushing the DNS cache by restarting nscd </span><span class="si">{result}</span><span class="s2">.&quot;</span>

    <span class="k">for</span> <span class="n">nscd_prefix</span> <span class="ow">in</span> <span class="n">nscd_prefixes</span><span class="p">:</span>
        <span class="n">nscd_cache</span> <span class="o">=</span> <span class="n">nscd_prefix</span> <span class="o">+</span> <span class="s2">&quot;/init.d/nscd&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">nscd_cache</span><span class="p">):</span>
            <span class="n">dns_cache_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">nscd_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/sudo&quot;</span><span class="p">,</span> <span class="n">nscd_cache</span><span class="p">,</span> <span class="s2">&quot;restart&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nscd_cmd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">nscd_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">nscd_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">nscd_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">))</span>

    <span class="n">system_prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="n">service_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NetworkManager&quot;</span><span class="p">,</span> <span class="s2">&quot;wicd&quot;</span><span class="p">,</span> <span class="s2">&quot;dnsmasq&quot;</span><span class="p">,</span> <span class="s2">&quot;networking&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">system_prefix</span> <span class="ow">in</span> <span class="n">system_prefixes</span><span class="p">:</span>
        <span class="n">systemctl</span> <span class="o">=</span> <span class="n">system_prefix</span> <span class="o">+</span> <span class="s2">&quot;/bin/systemctl&quot;</span>
        <span class="n">system_dir</span> <span class="o">=</span> <span class="n">system_prefix</span> <span class="o">+</span> <span class="s2">&quot;/lib/systemd/system&quot;</span>

        <span class="k">for</span> <span class="n">service_type</span> <span class="ow">in</span> <span class="n">service_types</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="n">service_type</span> <span class="o">+</span> <span class="s2">&quot;.service&quot;</span>
            <span class="n">service_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">system_dir</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>
            <span class="n">service_msg</span> <span class="o">=</span> <span class="s2">&quot;Flushing the DNS cache by restarting &quot;</span> <span class="o">+</span> <span class="n">service</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">{result}</span><span class="s2">.&quot;</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">service_file</span><span class="p">):</span>
                <span class="n">dns_cache_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">dns_service_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/sudo&quot;</span><span class="p">,</span> <span class="n">systemctl</span><span class="p">,</span> <span class="s2">&quot;restart&quot;</span><span class="p">,</span> <span class="n">service</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dns_service_cmd</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">dns_service_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">service_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">service_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">))</span>

    <span class="n">dns_clean_file</span> <span class="o">=</span> <span class="s2">&quot;/etc/init.d/dns-clean&quot;</span>
    <span class="n">dns_clean_msg</span> <span class="o">=</span> <span class="s2">&quot;Flushing the DNS cache via dns-clean executable </span><span class="si">{result}</span><span class="s2">.&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dns_clean_file</span><span class="p">):</span>
        <span class="n">dns_cache_found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">dns_clean_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/sudo&quot;</span><span class="p">,</span> <span class="n">dns_clean_file</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dns_clean_cmd</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">dns_clean_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">dns_clean_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">dns_clean_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dns_cache_found</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to determine DNS management tool.&quot;</span><span class="p">)</span>

    <span class="n">forget_credentials_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/sudo&quot;</span><span class="p">,</span> <span class="s2">&quot;-K&quot;</span><span class="p">]</span>
    <span class="n">forget_credentials_msg</span> <span class="o">=</span> <span class="s2">&quot;Removing cached sudo credentials </span><span class="si">{result}</span><span class="s2">.&quot;</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Command that will be executed:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">forget_credentials_cmd</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cmd_utils</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">forget_credentials_cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">forget_credentials_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">forget_credentials_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="s2">&quot;succeeded&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="new_profile_generation"><a class="viewcode-back" href="../../modules/HostsManager/HostsManagerApp.app_utils.html#HostsManagerApp.app_utils.new_profile_generation">[docs]</a><span class="k">def</span> <span class="nf">new_profile_generation</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a new profile.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    logger : object</span>
<span class="sd">        See &lt;class :any:`LogSystem`&gt;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">from</span><span class="o">.</span><span class="n">python_utils</span> <span class="kn">import</span> <span class="nn">prompts</span><span class="o">,</span> <span class="nn">template_utils</span>
    <span class="n">config_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_folder</span><span class="p">,</span> <span class="s2">&quot;AppData&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;templates&quot;</span><span class="p">,</span> <span class="s2">&quot;conf.py&quot;</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
    <span class="p">}</span>

    <span class="n">prompts</span><span class="o">.</span><span class="n">do_prompt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Enter a profile name&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>

    <span class="n">new_profile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_profiles_path</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_profile_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Profile seems to exists. Choose a different name.&quot;</span><span class="p">)</span>
        <span class="n">new_profile_generation</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_profile_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_profile_path</span><span class="p">,</span> <span class="s2">&quot;conf.py&quot;</span><span class="p">)</span>
        <span class="n">template_utils</span><span class="o">.</span><span class="n">generate_from_template</span><span class="p">(</span><span class="n">config_template</span><span class="p">,</span> <span class="n">config_path</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;New profile generated.&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020, Odyseus.

    </p>
  </div>
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a modified version of <a href="https://github.com/rtfd/sphinx_rtd_theme">sphinx-rtd-theme</a>. 

</footer>

        </div>
      </div>

      <a id="to-top-of-page" href="#top">
        <i class="fa fa-chevron-circle-up"></i>
      </a>

    </section>

  </div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>